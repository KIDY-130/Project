#76
# main.py
# FastAPI ì—”ë“œí¬ì¸íŠ¸ + Gradio UI(ë™ì¼ ì„œë²„ /ui ê²½ë¡œë¡œ ì ‘ê·¼)

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from pydantic import BaseModel
import asyncio
import json
import logging
from typing import Any, Dict

from crew import create_crew
from agents import strip_think  # ê²°ê³¼ ê°€ë…ì„± í–¥ìƒìš©
import gradio as gr
from gradio.routes import mount_gradio_app

# ë¡œê¹…
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ì§ë ¬í™” ìœ í‹¸
def serialize_object(obj):
    if isinstance(obj, tuple):
        return list(obj)
    elif isinstance(obj, dict):
        return obj
    elif hasattr(obj, '__dict__'):
        return obj.__dict__
    else:
        return str(obj)

def custom_json_dumps(data):
    return json.dumps(data, default=serialize_object, ensure_ascii=False, indent=2)

# FastAPI ì•±
app = FastAPI(
    title="CrewAI Content Generation API (Ollama / DeepSeek-R1)",
    version="1.0",
    description="í† í”½ì„ ê¸°ë°˜ìœ¼ë¡œ CrewAI(ì˜¤í”ˆì†ŒìŠ¤ LLM)ë¡œ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ëŠ” API + UI",
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ì…ë ¥ ëª¨ë¸
class TopicInput(BaseModel):
    topic: str

# === API: /crewai ===
@app.post("/crewai")
async def crewai_endpoint(input: TopicInput):
    try:
        crew = create_crew()
        # crew.kickoffëŠ” ë™ê¸° í•¨ìˆ˜ì´ë¯€ë¡œ ìŠ¤ë ˆë“œë¡œ ëŒë¦¼
        result = await asyncio.to_thread(crew.kickoff, {"topic": input.topic})

        # ê°€ëŠ¥í•œ ê²½ìš° Taskë³„ ì‚°ì¶œë¬¼ë„ í•¨ê»˜ êµ¬ì„± (ì—†ìœ¼ë©´ ì „ì²´ ë¬¸ìì—´ë§Œ ë°˜í™˜)
        try:
            # crew.tasksëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ì§€ë§Œ, ì•ˆì „í•˜ê²Œ ë¬¸ìì—´ ê²°ê³¼ë§Œ ìš°ì„  ë°˜í™˜
            payload: Dict[str, Any] = {
                "topic": input.topic,
                "result_text": strip_think(str(result)),
            }
        except Exception:
            payload = {"topic": input.topic, "result_text": strip_think(str(result))}

        return JSONResponse(content=json.loads(custom_json_dumps(payload)))
    except Exception as e:
        logger.exception("CrewAI endpoint ì—ëŸ¬ ë°œìƒ")
        raise HTTPException(status_code=500, detail=str(e))

# === Gradio UI (ë™ì¼ FastAPIì— ë§ˆìš´íŠ¸: /ui) ===
def build_gradio():
    with gr.Blocks(theme=gr.themes.Soft()) as demo:
        gr.Markdown("## ğŸ§© CrewAI Ã— DeepSeek-R1 (Ollama) â€” ì½˜í…ì¸  ìƒì„± UI")
        gr.Markdown("- í† í”½ì„ ì…ë ¥í•˜ê³  ì‹¤í–‰í•˜ë©´, ë¡œì»¬ ì˜¤í”ˆì†ŒìŠ¤ LLMìœ¼ë¡œ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")

        topic = gr.Textbox(
            label="í† í”½",
            value="ë‹¤ì¤‘ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ LangGraph, Autogen ë° CrewAIì˜ ë¹„êµ ì—°êµ¬",
            lines=2
        )
        run_btn = gr.Button("ì‹¤í–‰", variant="primary")
        out = gr.Markdown(label="ê²°ê³¼")

        async def run_ui(t: str):
            if not t or not t.strip():
                return "í† í”½ì„ ì…ë ¥í•˜ì„¸ìš”."
            crew = create_crew()
            result = await asyncio.to_thread(crew.kickoff, {"topic": t.strip()})
            return strip_think(str(result))

        run_btn.click(run_ui, inputs=[topic], outputs=[out])
        topic.submit(run_ui, inputs=[topic], outputs=[out])

    return demo

# FastAPIì— Gradio ì•± ë§ˆìš´íŠ¸
demo = build_gradio()
app = mount_gradio_app(app, demo, path="/ui")

# ë¡œì»¬ ì‹¤í–‰ ì§„ì…ì  (uvicorn main:app ë¡œ ì‹¤í–‰ ê¶Œì¥)
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=False)

