#43
"""
ë¡œì»¬ LLM (Ollama + DeepSeek-R1) + LlamaIndex + Gradio í†µí•© ë°ëª¨
- ì›ë³¸ ë…¸íŠ¸ë¶ì—ì„œ OpenAI ì˜ì¡´ ì œê±°
- Ollama ë¡œì»¬ LLM/ì„ë² ë”© ì‚¬ìš© (API Key ë¶ˆí•„ìš”)
- í´ë”/ì›¹/PDF ë°ì´í„° ìƒ‰ì¸ ë° ì§ˆì˜, ìƒ‰ì¸ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì§€ì›
- Gradio UI ì œê³µ

ì‚¬ì „ ì¤€ë¹„
1) Ollama ì„¤ì¹˜ & ì‹¤í–‰ (ê¸°ë³¸: http://localhost:11434)
2) ëª¨ë¸ ë‹¤ìš´ë¡œë“œ:
   - ì–¸ì–´ëª¨ë¸:  ollama pull deepseek-r1
   - ì„ë² ë”©:    ollama pull nomic-embed-text
3) íŒ¨í‚¤ì§€ ì„¤ì¹˜:
   pip install "llama-index>=0.10.0" llama-index-llms-ollama llama-index-embeddings-ollama \
               gradio requests pypdf beautifulsoup4

ë°ì´í„° ì˜ˆì‹œ
- 'data' í´ë”ì— í…ìŠ¤íŠ¸/ë§ˆí¬ë‹¤ìš´/HTML/PDF ë“± ë°°ì¹˜ ê°€ëŠ¥
- 'attention.pdf' ê°™ì€ PDF íŒŒì¼ì€ í˜„ì¬ ê²½ë¡œì— ë‘ë©´ ë©ë‹ˆë‹¤.
"""

from __future__ import annotations
import os
from pathlib import Path
from typing import Dict, Optional, List

import gradio as gr

# LlamaIndex í•µì‹¬ ëª¨ë“ˆ
from llama_index.core import (
    VectorStoreIndex,
    SimpleDirectoryReader,
    StorageContext,
    load_index_from_storage,
    Settings,
)

# Ollama LLM/ì„ë² ë”©
from llama_index.llms.ollama import Ollama
from llama_index.embeddings.ollama import OllamaEmbedding

# ì›¹ ë¡œë” (BeautifulSoup ê¸°ë°˜)
from llama_index.readers.web import BeautifulSoupWebReader


# ---------------------------
# ì „ì—­ ì„¤ì •: ë¡œì»¬ LLM + ì„ë² ë”©
# ---------------------------
DEFAULT_LLM_MODEL = "deepseek-r1"          # ì–¸ì–´ëª¨ë¸
DEFAULT_EMBED_MODEL = "nomic-embed-text"   # ì„ë² ë”© ëª¨ë¸ (Ollama ì§€ì›)

def configure_llamaindex(
    llm_model: str = DEFAULT_LLM_MODEL,
    embed_model: str = DEFAULT_EMBED_MODEL,
    temperature: float = 0.2,
    top_p: float = 0.95,
):
    """
    LlamaIndexì˜ ì „ì—­ Settingsì— ë¡œì»¬ Ollama LLM/ì„ë² ë”©ì„ ë“±ë¡.
    - OpenAI API í‚¤/ëª¨ë“ˆ ë¶ˆí•„ìš”
    """
    Settings.llm = Ollama(
        model=llm_model,
        request_timeout=120,
        temperature=temperature,
        top_p=top_p,
    )
    Settings.embed_model = OllamaEmbedding(model_name=embed_model)


# ---------------------------
# ê³µí†µ ìœ í‹¸: ìƒ‰ì¸ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------
def build_index_from_documents(documents, persist_dir: str) -> VectorStoreIndex:
    """
    ì£¼ì–´ì§„ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒ‰ì¸í•˜ê³  persist_dirì— ì €ì¥.
    """
    index = VectorStoreIndex.from_documents(documents)
    index.storage_context.persist(persist_dir=persist_dir)
    return index

def load_index(persist_dir: str) -> VectorStoreIndex:
    """
    ì €ì¥ëœ ìƒ‰ì¸ì„ persist_dirì—ì„œ ì¬ë¡œë”©.
    """
    storage_context = StorageContext.from_defaults(persist_dir=persist_dir)
    return load_index_from_storage(storage_context)


# ---------------------------
# ë°ì´í„° ì†ŒìŠ¤ë³„ ìƒ‰ì¸ í•¨ìˆ˜
# ---------------------------
def index_local_folder(
    folder_path: str,
    persist_dir: str,
) -> str:
    """
    ë¡œì»¬ í´ë”ì˜ íŒŒì¼ë“¤ë¡œë¶€í„° ìƒ‰ì¸ì„ ìƒì„±í•˜ê³  ì €ì¥.
    SimpleDirectoryReaderê°€ txt/md/html/pdf ë“± ë‹¤ì–‘í•œ í¬ë§·ì„ ìë™ ì²˜ë¦¬.
    """
    folder = Path(folder_path)
    if not folder.exists() or not folder.is_dir():
        return f"[ì˜¤ë¥˜] í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {folder_path}"

    documents = SimpleDirectoryReader(folder_path).load_data()
    index = build_index_from_documents(documents, persist_dir)
    # ì €ì¥ í›„ ê°„ë‹¨ ê²€ì¦ ì§ˆì˜(Optional)
    _ = index.as_query_engine()  # ì—”ì§„ ìƒì„±ë§Œ ìˆ˜í–‰
    return f"[ì™„ë£Œ] í´ë” ìƒ‰ì¸ ìƒì„± ë° ì €ì¥: {persist_dir} (ë¬¸ì„œ ìˆ˜: {len(documents)})"

def index_web_urls(
    urls_text: str,
    persist_dir: str,
) -> str:
    """
    ì¤„ë°”ê¿ˆ/ì‰¼í‘œ êµ¬ë¶„ìœ¼ë¡œ ì…ë ¥í•œ ì—¬ëŸ¬ URLì„ ìˆ˜ì§‘í•˜ì—¬ ìƒ‰ì¸ì„ ìƒì„±í•˜ê³  ì €ì¥.
    """
    urls: List[str] = []
    for token in urls_text.replace(",", "\n").splitlines():
        u = token.strip()
        if u:
            urls.append(u)
    if not urls:
        return "[ì˜¤ë¥˜] ìœ íš¨í•œ URLì´ ì—†ìŠµë‹ˆë‹¤."

    loader = BeautifulSoupWebReader()
    documents = loader.load_data(urls=urls)
    index = build_index_from_documents(documents, persist_dir)
    _ = index.as_query_engine()
    return f"[ì™„ë£Œ] ì›¹ ë¬¸ì„œ ìƒ‰ì¸ ìƒì„± ë° ì €ì¥: {persist_dir} (ë¬¸ì„œ ìˆ˜: {len(documents)})"

def index_pdf_files(
    file_paths_text: str,
    persist_dir: str,
) -> str:
    """
    ì¤„ë°”ê¿ˆ/ì‰¼í‘œë¡œ ì…ë ¥ëœ PDF ê²½ë¡œ ëª©ë¡ì„ ì½ì–´ ìƒ‰ì¸ ìƒì„±/ì €ì¥.
    (pypdfì— ì˜ì¡´, SimpleDirectoryReaderê°€ PDFë¥¼ ì²˜ë¦¬)
    """
    paths: List[Path] = []
    for token in file_paths_text.replace(",", "\n").splitlines():
        p = Path(token.strip())
        if p.exists() and p.is_file() and p.suffix.lower() == ".pdf":
            paths.append(p)
    if not paths:
        return "[ì˜¤ë¥˜] ìœ íš¨í•œ PDF íŒŒì¼ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤."

    # SimpleDirectoryReaderëŠ” ë””ë ‰í† ë¦¬ ì…ë ¥ì´ ê¸°ë³¸ì´ë¼, input_filesë¡œ ì§ì ‘ ì§€ì •
    documents = SimpleDirectoryReader(input_files=paths).load_data()
    index = build_index_from_documents(documents, persist_dir)
    _ = index.as_query_engine()
    return f"[ì™„ë£Œ] PDF ìƒ‰ì¸ ìƒì„± ë° ì €ì¥: {persist_dir} (ë¬¸ì„œ ìˆ˜: {len(documents)})"


# ---------------------------
# ì§ˆì˜/ì‘ë‹µ (ì €ì¥ëœ ìƒ‰ì¸ ëŒ€ìƒìœ¼ë¡œ)
# ---------------------------
def query_index(
    persist_dir: str,
    user_query: str,
    response_mode: str = "default",
) -> str:
    """
    ì €ì¥ëœ ìƒ‰ì¸(persist_dir)ì„ ë¡œë“œí•˜ì—¬ ì§ˆì˜ ìˆ˜í–‰.
    response_modeëŠ” LlamaIndex ResponseSynthesizer ëª¨ë“œ ì¤‘ í•˜ë‚˜(ê¸°ë³¸ê°’ 'default').
    """
    if not user_query.strip():
        return "[ì˜¤ë¥˜] ì§ˆì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."

    try:
        index = load_index(persist_dir)
    except Exception as e:
        return f"[ì˜¤ë¥˜] ìƒ‰ì¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒ‰ì¸ì„ ìƒì„±í•˜ì„¸ìš”.\n- persist_dir: {persist_dir}\n- ìƒì„¸: {e}"

    qe = index.as_query_engine(response_mode=response_mode)
    res = qe.query(user_query)
    return str(res)


# ---------------------------
# Gradio UI
# ---------------------------
with gr.Blocks(title="LlamaIndex + Ollama (DeepSeek-R1) RAG ë°ëª¨") as demo:
    gr.Markdown("## ğŸ” LlamaIndex + Ollama (DeepSeek-R1) RAG ë°ëª¨")
    gr.Markdown(
        "- **ë¡œì»¬ LLM/ì„ë² ë”©**ìœ¼ë¡œ ì‘ë™ (OpenAI í‚¤ ë¶ˆí•„ìš”)\n"
        "- í´ë”/ì›¹/PDF ë°ì´í„°ë¥¼ ìƒ‰ì¸í•˜ê³  ì €ì¥(persist), ì´í›„ ì¬ì‚¬ìš© ê°€ëŠ¥\n"
        "- í•œê¸€/ì˜ë¬¸ ì§ˆì˜ ëª¨ë‘ ê°€ëŠ¥ (ì˜ˆ: *What did the author do growing up?* / *í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì¤˜*)"
    )

    # ì „ì—­ ëª¨ë¸ ì„¤ì •
    with gr.Accordion("âš™ï¸ ì „ì—­ ëª¨ë¸ ì„¤ì • (Ollama)", open=True):
        with gr.Row():
            llm_model = gr.Textbox(label="LLM ëª¨ë¸", value=DEFAULT_LLM_MODEL, scale=2)
            embed_model = gr.Textbox(label="ì„ë² ë”© ëª¨ë¸", value=DEFAULT_EMBED_MODEL, scale=2)
        with gr.Row():
            temperature = gr.Slider(0.0, 1.5, value=0.2, step=0.05, label="temperature", scale=1)
            top_p = gr.Slider(0.1, 1.0, value=0.95, step=0.05, label="top_p", scale=1)
        apply_btn = gr.Button("ëª¨ë¸ ì„¤ì • ì ìš©", variant="primary")

    # ìƒ‰ì¸ ìƒì„± íƒ­ë“¤
    with gr.Tabs():
        with gr.Tab("ğŸ“ í´ë” ìƒ‰ì¸"):
            with gr.Row():
                folder_path = gr.Textbox(label="í´ë” ê²½ë¡œ", value="data", scale=3)
                persist_dir_folder = gr.Textbox(label="ì €ì¥ ê²½ë¡œ(persist_dir)", value="storage_folder", scale=2)
            build_folder_btn = gr.Button("í´ë” ìƒ‰ì¸ ìƒì„±/ì €ì¥", variant="primary")
            folder_status = gr.Textbox(label="ìƒíƒœ", lines=3)

        with gr.Tab("ğŸŒ ì›¹ URL ìƒ‰ì¸"):
            urls_text = gr.Textbox(
                label="URL ëª©ë¡ (ì‰¼í‘œ/ì¤„ë°”ê¿ˆ êµ¬ë¶„)",
                placeholder="ì˜ˆ) https://www.law.go.kr/ë²•ë ¹/ëŒ€í•œë¯¼êµ­í—Œë²•",
                lines=3,
            )
            persist_dir_web = gr.Textbox(label="ì €ì¥ ê²½ë¡œ(persist_dir)", value="storage_web")
            build_web_btn = gr.Button("ì›¹ ìƒ‰ì¸ ìƒì„±/ì €ì¥", variant="primary")
            web_status = gr.Textbox(label="ìƒíƒœ", lines=3)

        with gr.Tab("ğŸ“„ PDF ìƒ‰ì¸"):
            pdf_paths_text = gr.Textbox(
                label="PDF ê²½ë¡œ ëª©ë¡ (ì‰¼í‘œ/ì¤„ë°”ê¿ˆ êµ¬ë¶„)",
                placeholder="ì˜ˆ) ./attention.pdf",
                lines=3,
            )
            persist_dir_pdf = gr.Textbox(label="ì €ì¥ ê²½ë¡œ(persist_dir)", value="storage_pdf")
            build_pdf_btn = gr.Button("PDF ìƒ‰ì¸ ìƒì„±/ì €ì¥", variant="primary")
            pdf_status = gr.Textbox(label="ìƒíƒœ", lines=3)

    # ì§ˆì˜ ì˜ì—­
    gr.Markdown("---")
    gr.Markdown("### ğŸ’¬ ì§ˆì˜í•˜ê¸° (ì €ì¥ëœ ìƒ‰ì¸ ëŒ€ìƒ)")
    with gr.Row():
        persist_dir_query = gr.Textbox(label="ëŒ€ìƒ persist_dir", value="storage_folder", scale=2)
        response_mode = gr.Dropdown(
            ["default", "compact", "tree_summarize", "accumulate"],
            value="default",
            label="response_mode",
            scale=1,
        )
    user_query = gr.Textbox(
        label="ì§ˆì˜",
        placeholder="ì˜ˆ) What did the author do growing up? / í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì¤˜",
        lines=2,
    )
    ask_btn = gr.Button("ì§ˆì˜ ì‹¤í–‰ ğŸš€", variant="primary")
    answer_box = gr.Textbox(label="ì‘ë‹µ", lines=10)

    # ì´ë²¤íŠ¸ ë°”ì¸ë”©
    def _apply_models(llm, emb, temp, tp):
        configure_llamaindex(llm, emb, temp, tp)
        return f"[ì ìš©ë¨] LLM={llm}, EMB={emb}, temperature={temp}, top_p={tp}"

    apply_btn.click(
        fn=_apply_models,
        inputs=[llm_model, embed_model, temperature, top_p],
        outputs=[folder_status],  # ì•„ë¬´ íƒ­ì˜ ìƒíƒœì°½ í•˜ë‚˜ë¥¼ ê³µìš© ì•Œë¦¼ìœ¼ë¡œ í™œìš©
    )

    build_folder_btn.click(
        fn=index_local_folder,
        inputs=[folder_path, persist_dir_folder],
        outputs=[folder_status],
    )

    build_web_btn.click(
        fn=index_web_urls,
        inputs=[urls_text, persist_dir_web],
        outputs=[web_status],
    )

    build_pdf_btn.click(
        fn=index_pdf_files,
        inputs=[pdf_paths_text, persist_dir_pdf],
        outputs=[pdf_status],
    )

    ask_btn.click(
        fn=query_index,
        inputs=[persist_dir_query, user_query, response_mode],
        outputs=[answer_box],
    )

# ìµœì´ˆ êµ¬ë™ ì‹œ ê¸°ë³¸ ëª¨ë¸ ì„¤ì • ì ìš©
configure_llamaindex()

if __name__ == "__main__":
    demo.launch()
