#72
#!pip install crewai langchain langchain-community gradio
"""
CrewAI + ë¡œì»¬ Ollama(DeepSeek-R1) + Gradio ë°ëª¨
- ë‹«íŒ LLM(OpenAI) ì˜ì¡´ ì œê±°
- ëª¨ë“  ì—ì´ì „íŠ¸/ì‘ì—…ì´ ChatOllama(deepseek-r1:latest)ë¥¼ ì‚¬ìš©
- Gradio UIë¡œ í† í”½ ì…ë ¥ â†’ ê¸°íš â†’ ì§‘í•„ â†’ í¸ì§‘ â†’ í•œêµ­ì–´ ë³€í™˜ ìˆ˜í–‰
- DeepSeek-R1ì˜ <think> ì¶œë ¥ì„ ì œê±°í•˜ì—¬ ê¹”ë”í•œ ê²°ê³¼ ì œê³µ

ì‹¤í–‰:
    python app.py
ê·¸ë‹¤ìŒ ë¸Œë¼ìš°ì €ì—ì„œ http://127.0.0.1:7860 ì ‘ì†
"""

import re
from pathlib import Path
from typing import Dict, Any, Tuple

# CrewAI
from crewai import Agent, Task, Crew

# LangChain - Ollamaìš© ì±— ëª¨ë¸
from langchain_community.chat_models import ChatOllama

# UI
import gradio as gr


# =========================
# 1) ê³µí†µ LLM (ë¡œì»¬ Ollama)
# =========================
def get_llm():
    """
    ë¡œì»¬ Ollama DeepSeek-R1 ëª¨ë¸ì„ LangChain ChatOllamaë¡œ ë˜í•‘.
    - Ollamaê°€ localhost:11434ì—ì„œ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨.
    - ëª¨ë¸ëª…ì€ í™˜ê²½ì— ë§ê²Œ ë³€ê²½ ê°€ëŠ¥(ì˜ˆ: 'qwen2.5:7b', 'llama3.1:8b' ë“±)
    """
    return ChatOllama(
        model="deepseek-r1:latest",
        temperature=0.2,
        # ì•„ë˜ íŒŒë¼ë¯¸í„°ëŠ” í•„ìš”/ì„ í˜¸ì— ë”°ë¼ ì¡°ì •
        # keep_alive="5m",
        # num_ctx=4096,
    )


# =========================
# 2) DeepSeek-R1 <think> ì œê±° ìœ í‹¸
# =========================
def strip_think(text: str) -> str:
    """
    DeepSeek-R1ì´ ìƒì„±í•˜ëŠ” <think>...</think> ë‚´ë¶€ ì‚¬ìœ  í…ìŠ¤íŠ¸ë¥¼ ì œê±°.
    UIì— ë³´ì—¬ì¤„ ìµœì¢… ê²°ê³¼ë§Œ ë‚¨ê¹€.
    """
    if not isinstance(text, str):
        text = str(text)
    # <think> ... </think> ë¸”ë¡ ì „ì²´ ì œê±°
    text = re.sub(r"<think>.*?</think>", "", text, flags=re.DOTALL | re.IGNORECASE)
    # ì¤‘ë³µ ê³µë°± ì •ë¦¬
    text = re.sub(r"\n{3,}", "\n\n", text).strip()
    return text


# =========================
# 3) CrewAI íŒŒì´í”„ë¼ì¸ êµ¬ì„±
# =========================
def build_crew() -> Tuple[Crew, Dict[str, Task]]:
    llm = get_llm()

    # ì½˜í…ì¸  ê¸°íšì
    planner = Agent(
        role="ì½˜í…ì¸  ê¸°íšì",
        goal="{topic}ì— ëŒ€í•œ í¥ë¯¸ë¡­ê³  ì‚¬ì‹¤ì ì¸ ì½˜í…ì¸ ë¥¼ ê¸°íší•©ë‹ˆë‹¤",
        backstory=(
            "ë‹¹ì‹ ì€ {topic}ì— ëŒ€í•œ ë¸”ë¡œê·¸ ê¸°ì‚¬ë¥¼ ê¸°íší•˜ê³  ìˆìŠµë‹ˆë‹¤."
            "ì²­ì¤‘ì´ ë¬´ì–¸ê°€ë¥¼ ë°°ìš°ê³  ì •ë³´ì— ì…ê°í•œ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤."
            "ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì˜ ì¼ë¶€ê°€ ë˜ì–´ì•¼ í•˜ëŠ” ìì„¸í•œ ê°œìš”ì™€ ê´€ë ¨ëœ ì£¼ì œ ë° í•˜ìœ„ ì£¼ì œë¥¼ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ì‘ì—…ì€ ì´ ì£¼ì œì— ëŒ€í•œ ê¸°ì‚¬ë¥¼ ì‘ì„±í•˜ëŠ” ì½˜í…ì¸  ì‘ê°€ì˜ ê¸°ì´ˆê°€ ë©ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True,
    )

    # ì½˜í…ì¸  ì‘ê°€
    writer = Agent(
        role="ì½˜í…ì¸  ì‘ê°€",
        goal="ì£¼ì œ: {topic}ì— ëŒ€í•œ í†µì°°ë ¥ ìˆê³  ì‚¬ì‹¤ì ì¸ ì˜ê²¬ ê¸°ì‚¬ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤",
        backstory=(
            "ë‹¹ì‹ ì€ {topic}ì— ëŒ€í•œ ìƒˆë¡œìš´ ì˜ê²¬ ê¸°ì‚¬ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ê¸€ì€ ì½˜í…ì¸  ê¸°íšìì˜ ì‘ì—…ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ì½˜í…ì¸  ê¸°íšìëŠ” ê°œìš”ì™€ ê´€ë ¨ëœ ë§¥ë½ì„ ì œê³µí•©ë‹ˆë‹¤."
            "ì½˜í…ì¸  ê¸°íšìê°€ ì œê³µí•œ ê°œìš”ì˜ ì£¼ìš” ëª©í‘œì™€ ë°©í–¥ì„ ë”°ë¦…ë‹ˆë‹¤."
            "ë˜í•œ ì½˜í…ì¸  ê¸°íšìê°€ ì œê³µí•œ ì •ë³´ë¡œ ë’·ë°›ì¹¨ë˜ëŠ” ê°ê´€ì ì´ê³  ê³µì •í•œ í†µì°°ë ¥ì„ ì œê³µí•©ë‹ˆë‹¤."
            "ì˜ê²¬ ì§„ìˆ ê³¼ ê°ê´€ì  ì§„ìˆ ì„ êµ¬ë¶„í•˜ì—¬ ì˜ê²¬ ê¸°ì‚¬ì— ë°˜ì˜í•©ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True,
    )

    # í¸ì§‘ì
    editor = Agent(
        role="í¸ì§‘ì",
        goal="ì£¼ì–´ì§„ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë¸”ë¡œê·¸ ê¸€ì“°ê¸° ìŠ¤íƒ€ì¼ì— ë§ê²Œ í¸ì§‘í•©ë‹ˆë‹¤.",
        backstory=(
            "ë‹¹ì‹ ì€ ì½˜í…ì¸  ì‘ê°€ë¡œë¶€í„° ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë°›ëŠ” í¸ì§‘ìì…ë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì´ ì €ë„ë¦¬ì¦˜ì˜ ëª¨ë²” ì‚¬ë¡€ë¥¼ ë”°ë¥´ê³ ,"
            "ì˜ê²¬ì´ë‚˜ ì£¼ì¥ ì‹œ ê· í˜• ì¡íŒ ê´€ì ì„ ì œê³µí•˜ë©°,"
            "ê°€ëŠ¥í•˜ë‹¤ë©´ ì£¼ìš” ë…¼ë€ì´ ë˜ëŠ” ì£¼ì œë‚˜ ì˜ê²¬ì„ í”¼í•˜ë„ë¡ ê²€í† í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True,
    )

    # í•œêµ­ì–´ ë³€í™˜ê¸° (ìë™ ì–¸ì–´ ê°ì§€ â†’ í•œêµ­ì–´)
    translator = Agent(
        role="translator",
        goal="Translate to Korean",
        backstory="ì–¸ì–´ë¥¼ ê°ì§€í•´ì„œ í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë°”ê¿”ì„œ ì‘ì„±í•´ì¤˜.",
        llm=llm,
        allow_delegation=False,
        verbose=True,
        memory=True,
    )

    # ===== Tasks =====
    plan = Task(
        description=(
            "1. {topic}ì— ëŒ€í•œ ìµœì‹  ë™í–¥, ì£¼ìš” ì¸ë¬¼, ì£¼ëª©í•  ë§Œí•œ ë‰´ìŠ¤ë¥¼ ìš°ì„ ìˆœìœ„ì— ë‘¡ë‹ˆë‹¤.\n"
            "2. ëŒ€ìƒ ì²­ì¤‘ì„ ì‹ë³„í•˜ê³  ê·¸ë“¤ì˜ ê´€ì‹¬ì‚¬ì™€ ì–´ë ¤ì›€ì„ ê³ ë ¤í•©ë‹ˆë‹¤.\n"
            "3. ì†Œê°œ, ì£¼ìš” í¬ì¸íŠ¸, í–‰ë™ ì´‰êµ¬ë¥¼ í¬í•¨í•œ ìì„¸í•œ ì½˜í…ì¸  ê°œìš”ë¥¼ ê°œë°œí•©ë‹ˆë‹¤.\n"
            "4. SEO í‚¤ì›Œë“œì™€ ê´€ë ¨ ë°ì´í„° ë˜ëŠ” ì†ŒìŠ¤ë¥¼ í¬í•¨í•©ë‹ˆë‹¤."
        ),
        expected_output=(
            "ê°œìš”, ì²­ì¤‘ ë¶„ì„, SEO í‚¤ì›Œë“œ, ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•œ í¬ê´„ì ì¸ ì½˜í…ì¸  ê³„íš ë¬¸ì„œ."
        ),
        agent=planner,
    )

    write = Task(
        description=(
            "1. ì½˜í…ì¸  ê³„íšì„ ì‚¬ìš©í•˜ì—¬ {topic}ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.\n"
            "2. SEO í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•©ë‹ˆë‹¤.\n"
            "3. ì„¹ì…˜/ë¶€ì œëª©ì€ ë§¤ë ¥ì ì¸ ë°©ì‹ìœ¼ë¡œ ì ì ˆí•˜ê²Œ ëª…ëª…ë©ë‹ˆë‹¤.\n"
            "4. ë§¤ë ¥ì ì¸ ì†Œê°œ, í†µì°°ë ¥ ìˆëŠ” ë³¸ë¬¸, ìš”ì•½ ê²°ë¡ ìœ¼ë¡œ êµ¬ì¡°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.\n"
            "5. ë¬¸ë²• ì˜¤ë¥˜ì™€ ë¸Œëœë“œì˜ ìŒì„±ì— ë§ê²Œ êµì •í•©ë‹ˆë‹¤.\n"
        ),
        expected_output=(
            "ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì˜ ì‘ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ë¡œ, ê° ì„¹ì…˜ì€ 2~3ê°œì˜ ë‹¨ë½ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, ì¶œíŒ ì¤€ë¹„ê°€ ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        ),
        agent=writer,
    )

    edit = Task(
        description="ì£¼ì–´ì§„ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë¬¸ë²• ì˜¤ë¥˜ì™€ ë¸Œëœë“œì˜ ìŒì„±ì— ë§ê²Œ êµì •í•©ë‹ˆë‹¤.",
        expected_output=(
            "ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì˜ ì‘ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ë¡œ, ê° ì„¹ì…˜ì€ 2~3ê°œì˜ ë‹¨ë½ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, ì¶œíŒ ì¤€ë¹„ê°€ ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        ),
        agent=editor,
    )

    translate_task = Task(
        description=(
            "ì£¼ì œì— ëŒ€í•´ ì—°êµ¬ì›ì´ ì‘ì„±í•´ì¤€ ë³´ê³ ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ 2ë‹¨ë½ 5000ìë¡œ ìš”ì•½í•˜ì—¬ì„œ í•œêµ­ì–´ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤."
        ),
        expected_output=(
            "ì£¼ì œì— ëŒ€í•´ ì—°êµ¬ì›ì´ ì‘ì„±í•´ì¤€ ë³´ê³ ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œêµ­ì–´ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤."
        ),
        agent=translator,
        async_execution=False,
        output_file="translated-blog.md",
    )

    crew = Crew(
        agents=[planner, writer, editor, translator],
        tasks=[plan, write, edit, translate_task],
        verbose=True,
    )

    # íƒœìŠ¤í¬ ì°¸ì¡°ë¥¼ UIì—ì„œ ë³´ê¸° ì¢‹ê²Œ ë°˜í™˜
    tasks = {
        "plan": plan,
        "write": write,
        "edit": edit,
        "translate": translate_task,
    }
    return crew, tasks


# =========================
# 4) ì‹¤í–‰ ë˜í¼
# =========================
def run_pipeline(topic: str) -> Dict[str, Any]:
    """
    CrewAI í¬ë£¨ë¥¼ ë¹Œë“œí•˜ê³  ì£¼ì–´ì§„ í† í”½ìœ¼ë¡œ ì‹¤í–‰.
    ê° ë‹¨ê³„ì˜ ì›ì‹œ ì¶œë ¥ì—ì„œ <think>ë¥¼ ì œê±°í•´ UIì— ì í•©í•œ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜.
    """
    crew, tasks = build_crew()

    # kickoff ì‹¤í–‰
    result = crew.kickoff(inputs={"topic": topic})

    # ê° íƒœìŠ¤í¬ì˜ ì‚°ì¶œë¬¼ ì¶”ì¶œ(í¬ë£¨ ì‹¤í–‰ ì´í›„ .output ì ‘ê·¼ ê°€ëŠ¥)
    def safe_output(t: Task) -> str:
        try:
            raw = getattr(t.output, "raw", None) or str(t.output)
            return strip_think(raw)
        except Exception:
            return ""

    outputs = {
        "plan": safe_output(tasks["plan"]),
        "write": safe_output(tasks["write"]),
        "edit": safe_output(tasks["edit"]),
        "translate": safe_output(tasks["translate"]),
        "final": strip_think(str(result)),
    }

    # ë²ˆì—­ íŒŒì¼ ì €ì¥ ì—¬ë¶€ ì•ˆë‚´ (CrewAIê°€ íŒŒì¼ ì €ì¥ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ)
    # ì—¬ê¸°ì„œë„ ë³´ì¡° ì €ì¥(ì˜µì…˜)
    out_path = Path("translated-blog.md")
    if outputs["translate"]:
        try:
            out_path.write_text(outputs["translate"], encoding="utf-8")
        except Exception:
            pass

    return outputs


# =========================
# 5) Gradio UI
# =========================
def make_ui():
    with gr.Blocks(theme=gr.themes.Soft()) as demo:
        gr.Markdown("## ğŸ§© CrewAI Ã— DeepSeek-R1 (Ollama) â€” ë¸”ë¡œê·¸ ì½˜í…ì¸  íŒŒì´í”„ë¼ì¸")
        gr.Markdown(
            "- í† í”½ì„ ì…ë ¥í•˜ë©´ **ê¸°íš â†’ ì§‘í•„ â†’ í¸ì§‘ â†’ í•œêµ­ì–´ ë³€í™˜** ê³¼ì •ì„ ë¡œì»¬ LLMìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.\n"
            "- ê²°ê³¼ë¬¼ ì¤‘ ë²ˆì—­(í•œêµ­ì–´)ì€ `translated-blog.md`ë¡œë„ ì €ì¥ë©ë‹ˆë‹¤."
        )

        topic = gr.Textbox(
            label="í† í”½(ì˜ˆ: LangGraph, Autogen, CrewAI ë¹„êµ ì—°êµ¬)",
            value="ë‹¤ì¤‘ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ LangGraph, Autogen ë° CrewAIì˜ ë¹„êµ ì—°êµ¬",
            lines=2,
        )
        run_btn = gr.Button("ì‹¤í–‰", variant="primary")

        with gr.Tab("ê¸°íš ê²°ê³¼"):
            plan_out = gr.Markdown()
        with gr.Tab("ì‘ì„± ê²°ê³¼"):
            write_out = gr.Markdown()
        with gr.Tab("í¸ì§‘ ê²°ê³¼"):
            edit_out = gr.Markdown()
        with gr.Tab("í•œêµ­ì–´ ë³€í™˜ ê²°ê³¼(ìµœì¢…ë³¸)"):
            trans_out = gr.Markdown()
        with gr.Accordion("ì „ì²´ ê²°ê³¼(raw) ë³´ê¸°", open=False):
            final_out = gr.Markdown()

        def on_click(t):
            if not t or not t.strip():
                return ("í† í”½ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "", "", "", "")
            res = run_pipeline(t.strip())
            return (
                res.get("plan", ""),
                res.get("write", ""),
                res.get("edit", ""),
                res.get("translate", ""),
                res.get("final", ""),
            )

        run_btn.click(
            on_click,
            inputs=[topic],
            outputs=[plan_out, write_out, edit_out, trans_out, final_out],
        )
        topic.submit(
            on_click,
            inputs=[topic],
            outputs=[plan_out, write_out, edit_out, trans_out, final_out],
        )

    return demo


# =========================
# 6) main
# =========================
if __name__ == "__main__":
    app = make_ui()
    # ë¡œì»¬ ì‚¬ìš©: share=False, ì™¸ë¶€ ê³µìœ  í•„ìš”ì‹œ True
    app.launch(server_name="0.0.0.0", server_port=7860, share=False)









 



