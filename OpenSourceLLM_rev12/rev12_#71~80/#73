#73
"""
[OpenCode ë³€í™˜ë³¸]
Closed LLM(OpenAI) ì˜ì¡´ ì½”ë“œë¥¼ ë¡œì»¬ ì˜¤í”ˆì†ŒìŠ¤ LLM(Ollama + DeepSeek-R1)ìœ¼ë¡œ ì „í™˜í•˜ê³ ,
Gradio UIë¥¼ ë¶™ì—¬ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ì¼ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

ì‚¬ì „ ì¤€ë¹„:
1) Ollama ì„¤ì¹˜ í›„ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
   - ollama pull deepseek-r1:latest
2) í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
   - pip install crewai langchain langchain-community gradio

ì‹¤í–‰:
    python app.py
ë¸Œë¼ìš°ì €ì—ì„œ http://127.0.0.1:7860 ì ‘ì†
"""

import re
from pathlib import Path
from typing import Dict, Any, Tuple

# CrewAI
from crewai import Agent, Task, Crew

# LangChain - Ollamaìš© ì±— ëª¨ë¸ (OpenAIê°€ ì•„ë‹Œ ì˜¤í”ˆì†ŒìŠ¤ LLM)
from langchain_community.chat_models import ChatOllama

# UI
import gradio as gr


# =========================
# 1) ë¡œì»¬ LLM ì„¤ì • (Ollama + DeepSeek-R1)
# =========================
def get_llm() -> ChatOllama:
    """
    ë¡œì»¬ì—ì„œ êµ¬ë™ë˜ëŠ” Ollamaì˜ DeepSeek-R1 ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - API í‚¤ ë¶ˆí•„ìš”
    - OllamaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ http://localhost:11434 ë¡œ ë–  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    """
    return ChatOllama(
        model="deepseek-r1:latest",  # í•„ìš” ì‹œ ë‹¤ë¥¸ ë¡œì»¬ ëª¨ë¸ëª…ìœ¼ë¡œ êµì²´ ê°€ëŠ¥ (ì˜ˆ: "llama3.1:8b")
        temperature=0.2,
        # num_ctx=4096,  # ë¬¸ë§¥ ê¸¸ì´ ì¡°ì •ì´ í•„ìš”í•˜ë©´ í™œì„±í™”
    )


# =========================
# 2) DeepSeek-R1ì˜ <think> ë¸”ë¡ ì œê±° ìœ í‹¸
# =========================
def strip_think(text: str) -> str:
    """
    DeepSeek-R1ì€ ì‚¬ìœ  í…ìŠ¤íŠ¸ë¥¼ <think>...</think> íƒœê·¸ë¡œ ë‚´ë³´ë‚´ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.
    UI ê°€ë…ì„±ì„ ìœ„í•´ í•´ë‹¹ ë¶€ë¶„ì„ ì œê±°í•©ë‹ˆë‹¤.
    """
    if not isinstance(text, str):
        text = str(text)
    text = re.sub(r"<think>.*?</think>", "", text, flags=re.DOTALL | re.IGNORECASE)
    text = re.sub(r"\n{3,}", "\n\n", text).strip()
    return text


# =========================
# 3) ì—ì´ì „íŠ¸ ì •ì˜ (ì›ë¬¸ì˜ ì˜ë„ ìœ ì§€, OpenAI â†’ Ollama)
# =========================
def build_agents(llm: ChatOllama):
    """
    ì‚¬ìš©ìê°€ ì œê³µí•œ ì—ì´ì „íŠ¸ ì •ì˜ë¥¼ ì˜¤í”ˆì†ŒìŠ¤ LLMë¡œ ë™ì‘í•˜ë„ë¡ ë³€í™˜.
    - ChatOpenAI â†’ ChatOllama
    - ë‚˜ë¨¸ì§€ êµ¬ì„±/ëª©í‘œ/ë°°ê²½ì€ ë™ì¼
    """
    # ì½˜í…ì¸  ê¸°íšì
    planner = Agent(
        role="ì½˜í…ì¸  ê¸°íšì",
        goal="{topic}ì— ëŒ€í•œ í¥ë¯¸ë¡­ê³  ì‚¬ì‹¤ì ì¸ ì½˜í…ì¸ ë¥¼ ê¸°íší•©ë‹ˆë‹¤",
        backstory=(
            "ë‹¹ì‹ ì€ {topic}ì— ëŒ€í•œ ë¸”ë¡œê·¸ ê¸°ì‚¬ë¥¼ ê¸°íší•˜ê³  ìˆìŠµë‹ˆë‹¤."
            "ì²­ì¤‘ì´ ë¬´ì–¸ê°€ë¥¼ ë°°ìš°ê³  ì •ë³´ì— ì…ê°í•œ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤."
            "ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì˜ ì¼ë¶€ê°€ ë˜ì–´ì•¼ í•˜ëŠ” ìì„¸í•œ ê°œìš”ì™€ ê´€ë ¨ëœ ì£¼ì œ ë° í•˜ìœ„ ì£¼ì œë¥¼ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ì‘ì—…ì€ ì´ ì£¼ì œì— ëŒ€í•œ ê¸°ì‚¬ë¥¼ ì‘ì„±í•˜ëŠ” ì½˜í…ì¸  ì‘ê°€ì˜ ê¸°ì´ˆê°€ ë©ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True
    )

    # ì½˜í…ì¸  ì‘ê°€
    writer = Agent(
        role="ì½˜í…ì¸  ì‘ê°€",
        goal="ì£¼ì œ: {topic}ì— ëŒ€í•œ í†µì°°ë ¥ ìˆê³  ì‚¬ì‹¤ì ì¸ ì˜ê²¬ ê¸°ì‚¬ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤",
        backstory=(
            "ë‹¹ì‹ ì€ {topic}ì— ëŒ€í•œ ìƒˆë¡œìš´ ì˜ê²¬ ê¸°ì‚¬ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ê¸€ì€ ì½˜í…ì¸  ê¸°íšìì˜ ì‘ì—…ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, ì½˜í…ì¸  ê¸°íšìëŠ” ê°œìš”ì™€ ê´€ë ¨ëœ ë§¥ë½ì„ ì œê³µí•©ë‹ˆë‹¤."
            "ì½˜í…ì¸  ê¸°íšìê°€ ì œê³µí•œ ê°œìš”ì˜ ì£¼ìš” ëª©í‘œì™€ ë°©í–¥ì„ ë”°ë¦…ë‹ˆë‹¤."
            "ë˜í•œ ì½˜í…ì¸  ê¸°íšìê°€ ì œê³µí•œ ì •ë³´ë¡œ ë’·ë°›ì¹¨ë˜ëŠ” ê°ê´€ì ì´ê³  ê³µì •í•œ í†µì°°ë ¥ì„ ì œê³µí•©ë‹ˆë‹¤."
            "ì˜ê²¬ ì§„ìˆ ê³¼ ê°ê´€ì  ì§„ìˆ ì„ êµ¬ë¶„í•˜ì—¬ ì˜ê²¬ ê¸°ì‚¬ì—ì„œ ì¸ì •í•©ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True
    )

    # í¸ì§‘ì
    editor = Agent(
        role="í¸ì§‘ì",
        goal="ì£¼ì–´ì§„ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë¸”ë¡œê·¸ ê¸€ì“°ê¸° ìŠ¤íƒ€ì¼ì— ë§ê²Œ í¸ì§‘í•©ë‹ˆë‹¤.",
        backstory=(
            "ë‹¹ì‹ ì€ ì½˜í…ì¸  ì‘ê°€ë¡œë¶€í„° ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë°›ëŠ” í¸ì§‘ìì…ë‹ˆë‹¤."
            "ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì´ ì €ë„ë¦¬ì¦˜ì˜ ëª¨ë²” ì‚¬ë¡€ë¥¼ ë”°ë¥´ê³ ,"
            "ì˜ê²¬ì´ë‚˜ ì£¼ì¥ ì‹œ ê· í˜• ì¡íŒ ê´€ì ì„ ì œê³µí•˜ë©°,"
            "ê°€ëŠ¥í•˜ë‹¤ë©´ ì£¼ìš” ë…¼ë€ì´ ë˜ëŠ” ì£¼ì œë‚˜ ì˜ê²¬ì„ í”¼í•˜ë„ë¡ ê²€í† í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤."
        ),
        llm=llm,
        allow_delegation=False,
        verbose=True
    )

    # ë²ˆì—­ê°€ (ìë™ ì–¸ì–´ ê°ì§€ â†’ í•œêµ­ì–´)
    translator = Agent(
        role="ë²ˆì—­ê°€",
        goal="í•œêµ­ì–´ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤",
        backstory="ì–¸ì–´ë¥¼ ê°ì§€í•˜ì—¬ í•œêµ­ì–´ë¡œ ë³€í™˜í•˜ì—¬ ì‘ì„±í•´ì¤ë‹ˆë‹¤.",
        llm=llm,
        allow_delegation=False,
        verbose=True,
        memory=True
    )

    return planner, writer, editor, translator


# =========================
# 4) ì‘ì—…(Task) ë° í¬ë£¨(Crew) êµ¬ì„±
# =========================
def build_tasks(planner: Agent, writer: Agent, editor: Agent, translator: Agent):
    """
    ìµœì†Œ ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì´í”„ë¼ì¸:
    - ê¸°íš â†’ ì§‘í•„ â†’ í¸ì§‘ â†’ ë²ˆì—­(í•œêµ­ì–´)
    """
    plan = Task(
        description=(
            "1. {topic}ì— ëŒ€í•œ ìµœì‹  ë™í–¥, ì£¼ìš” ì¸ë¬¼, ì£¼ëª©í•  ë§Œí•œ ë‰´ìŠ¤ë¥¼ ìš°ì„ ìˆœìœ„ì— ë‘¡ë‹ˆë‹¤.\n"
            "2. ëŒ€ìƒ ì²­ì¤‘ì„ ì‹ë³„í•˜ê³  ê·¸ë“¤ì˜ ê´€ì‹¬ì‚¬ì™€ ì–´ë ¤ì›€ì„ ê³ ë ¤í•©ë‹ˆë‹¤.\n"
            "3. ì†Œê°œ, ì£¼ìš” í¬ì¸íŠ¸, í–‰ë™ ì´‰êµ¬ë¥¼ í¬í•¨í•œ ìì„¸í•œ ì½˜í…ì¸  ê°œìš”ë¥¼ ê°œë°œí•©ë‹ˆë‹¤.\n"
            "4. SEO í‚¤ì›Œë“œì™€ ê´€ë ¨ ë°ì´í„° ë˜ëŠ” ì†ŒìŠ¤ë¥¼ í¬í•¨í•©ë‹ˆë‹¤."
        ),
        expected_output="ê°œìš”, ì²­ì¤‘ ë¶„ì„, SEO í‚¤ì›Œë“œ, ë¦¬ì†ŒìŠ¤ë¥¼ í¬í•¨í•œ í¬ê´„ì ì¸ ì½˜í…ì¸  ê³„íš ë¬¸ì„œ.",
        agent=planner,
    )

    write = Task(
        description=(
            "1. ì½˜í…ì¸  ê³„íšì„ ì‚¬ìš©í•˜ì—¬ {topic}ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.\n"
            "2. SEO í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•©ë‹ˆë‹¤.\n"
            "3. ì„¹ì…˜/ë¶€ì œëª©ì€ ë§¤ë ¥ì ì¸ ë°©ì‹ìœ¼ë¡œ ì ì ˆí•˜ê²Œ ëª…ëª…ë©ë‹ˆë‹¤.\n"
            "4. ë§¤ë ¥ì ì¸ ì†Œê°œ, í†µì°°ë ¥ ìˆëŠ” ë³¸ë¬¸, ìš”ì•½ ê²°ë¡ ìœ¼ë¡œ êµ¬ì¡°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.\n"
            "5. ë¬¸ë²• ì˜¤ë¥˜ì™€ ë¸Œëœë“œì˜ ìŒì„±ì— ë§ê²Œ êµì •í•©ë‹ˆë‹¤.\n"
        ),
        expected_output="ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì˜ ì‘ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼(ê° ì„¹ì…˜ 2~3ë‹¨ë½, ì¶œíŒ ì¤€ë¹„ ì™„ë£Œ).",
        agent=writer,
    )

    edit = Task(
        description="ì£¼ì–´ì§„ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ ë¬¸ë²• ì˜¤ë¥˜ì™€ ë¸Œëœë“œì˜ ìŒì„±ì— ë§ê²Œ êµì •í•©ë‹ˆë‹¤.",
        expected_output="ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì˜ ì‘ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼(ê° ì„¹ì…˜ 2~3ë‹¨ë½, ì¶œíŒ ì¤€ë¹„ ì™„ë£Œ).",
        agent=editor,
    )

    translate_task = Task(
        description=(
            "ë°©ê¸ˆ ì™„ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì„ 2ë‹¨ë½, ì´ 5,000ì ë‚´ì™¸ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. "
            "ê°€ëŠ¥í•˜ë©´ ìš©ì–´ í†µì¼ ë° ë¬¸ì¥ ë‹¤ë“¬ê¸°ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”."
        ),
        expected_output="í•œêµ­ì–´ë¡œ ì™„ì„±ëœ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼(ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì²´, ìš©ì–´ í†µì¼).",
        agent=translator,
        async_execution=False,
        output_file="translated-blog.md",
    )

    return {
        "plan": plan,
        "write": write,
        "edit": edit,
        "translate": translate_task,
    }


def build_crew(tasks: Dict[str, Task], agents_tuple) -> Crew:
    """
    Crew ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    planner, writer, editor, translator = agents_tuple
    crew = Crew(
        agents=[planner, writer, editor, translator],
        tasks=[tasks["plan"], tasks["write"], tasks["edit"], tasks["translate"]],
        verbose=True,
    )
    return crew


# =========================
# 5) ì‹¤í–‰ ë˜í¼ (Gradioì—ì„œ í˜¸ì¶œ)
# =========================
def run_pipeline(topic: str) -> Dict[str, Any]:
    """
    - ì…ë ¥ topicìœ¼ë¡œ Crew íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    - ê° ë‹¨ê³„ ì‚°ì¶œë¬¼ì„ ìˆ˜ì§‘í•˜ê³  DeepSeek-R1ì˜ <think> í…ìŠ¤íŠ¸ë¥¼ ì œê±°
    - ë²ˆì—­ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œë„ ì €ì¥
    """
    llm = get_llm()
    agents = build_agents(llm)
    tasks = build_tasks(*agents)
    crew = build_crew(tasks, agents)

    # Crew ì‹¤í–‰
    result = crew.kickoff(inputs={"topic": topic})

    # íƒœìŠ¤í¬ë³„ ì‚°ì¶œë¬¼ ì¶”ì¶œ ìœ í‹¸
    def safe_output(task: Task) -> str:
        try:
            raw = getattr(task.output, "raw", None) or str(task.output)
            return strip_think(raw)
        except Exception:
            return ""

    outputs = {
        "plan": safe_output(tasks["plan"]),
        "write": safe_output(tasks["write"]),
        "edit": safe_output(tasks["edit"]),
        "translate": safe_output(tasks["translate"]),
        "final": strip_think(str(result)),
    }

    # ë²ˆì—­ ê²°ê³¼ ì €ì¥ (Crewì˜ output_fileê³¼ ë³„ê°œë¡œ ë³´ì¡° ì €ì¥)
    if outputs["translate"]:
        try:
            Path("translated-blog.md").write_text(outputs["translate"], encoding="utf-8")
        except Exception:
            pass

    return outputs


# =========================
# 6) Gradio UI
# =========================
def make_ui():
    """
    ê°„ë‹¨í•œ ë‹¨ì¼ í™”ë©´ UI:
    - í† í”½ ì…ë ¥ â†’ ì‹¤í–‰
    - íƒ­ìœ¼ë¡œ ê° ë‹¨ê³„ ê²°ê³¼ í™•ì¸
    """
    with gr.Blocks(theme=gr.themes.Soft()) as demo:
        gr.Markdown("## ğŸ§© CrewAI Ã— DeepSeek-R1 (Ollama) â€” ì½˜í…ì¸  ì œì‘ íŒŒì´í”„ë¼ì¸")
        gr.Markdown(
            "- ë¡œì»¬ ì˜¤í”ˆì†ŒìŠ¤ LLMë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤ (API í‚¤ ë¶ˆí•„ìš”).\n"
            "- ê¸°íš â†’ ì§‘í•„ â†’ í¸ì§‘ â†’ í•œêµ­ì–´ ë³€í™˜ ê²°ê³¼ë¥¼ íƒ­ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤."
        )

        topic = gr.Textbox(
            label="í† í”½(ì˜ˆ: LangGraph, Autogen, CrewAI ë¹„êµ ì—°êµ¬)",
            value="ë‹¤ì¤‘ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ LangGraph, Autogen ë° CrewAIì˜ ë¹„êµ ì—°êµ¬",
            lines=2,
        )
        run_btn = gr.Button("íŒŒì´í”„ë¼ì¸ ì‹¤í–‰", variant="primary")

        with gr.Tab("â‘  ê¸°íš(Planner)"):
            out_plan = gr.Markdown()
        with gr.Tab("â‘¡ ì§‘í•„(Writer)"):
            out_write = gr.Markdown()
        with gr.Tab("â‘¢ í¸ì§‘(Editor)"):
            out_edit = gr.Markdown()
        with gr.Tab("â‘£ í•œêµ­ì–´ ë³€í™˜(Translator/ìµœì¢…ë³¸)"):
            out_trans = gr.Markdown()
        with gr.Accordion("ì „ì²´ ê²°ê³¼(raw) ë³´ê¸°", open=False):
            out_final = gr.Markdown()

        def on_run(t):
            if not t or not t.strip():
                return ("í† í”½ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "", "", "", "")
            res = run_pipeline(t.strip())
            return (
                res.get("plan", ""),
                res.get("write", ""),
                res.get("edit", ""),
                res.get("translate", ""),
                res.get("final", ""),
            )

        run_btn.click(on_run, inputs=[topic],
                      outputs=[out_plan, out_write, out_edit, out_trans, out_final])
        topic.submit(on_run, inputs=[topic],
                     outputs=[out_plan, out_write, out_edit, out_trans, out_final])

    return demo


# =========================
# 7) main
# =========================
if __name__ == "__main__":
    app = make_ui()
    # ë¡œì»¬ ì‚¬ìš©: share=False (ì›ê²© ê³µìœ  í•„ìš” ì‹œ True)
    app.launch(server_name="0.0.0.0", server_port=7860, share=False)





