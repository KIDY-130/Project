#83
"""
LlamaIndex + Gemini ì˜ˆì œ âœ ì˜¤í”ˆì†ŒìŠ¤ ë¡œì»¬ ìŠ¤íƒìœ¼ë¡œ ë³€í™˜
- LLM: **Ollama ë¡œì»¬ ì„œë²„ì˜ DeepSeek-R1** (ì˜ˆ: `ollama pull deepseek-r1`)
- Embedding: **HuggingFace BAAI/bge-m3** (ë¡œì»¬ ê°€ì¤‘ì¹˜ ìë™ ìºì‹œ)
- Vector Index: **LlamaIndex VectorStoreIndex** (ë””ìŠ¤í¬ ì˜ì†í™” í¬í•¨)
- GUI: **Gradio** (ë¬¸ì„œ ì—…ë¡œë“œ/ì¸ë±ì‹±/ì§ˆì˜/ì €ì¥Â·ë¶ˆëŸ¬ì˜¤ê¸°)

â€» ì™¸ë¶€ API í‚¤ ë¶ˆí•„ìš”. ëª¨ë“  ì¶”ë¡ /ì„ë² ë”©ì´ ë¡œì»¬ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.
ì‘ì„±: OpenCode
"""

# =====================
# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜(ìµœì´ˆ 1íšŒ)
# =====================
# pip install llama-index==0.11.20 llama-index-llms-ollama llama-index-embeddings-huggingface gradio

import os
import shutil
import tempfile
import logging
from pathlib import Path
from typing import List

import gradio as gr

from llama_index.core import Settings, SimpleDirectoryReader, VectorStoreIndex, StorageContext, load_index_from_storage
from llama_index.llms.ollama import Ollama
from llama_index.embeddings.huggingface import HuggingFaceEmbedding

# ---------------------
# ë¡œê¹… ì„¤ì • (ë””ë²„ê¹…ìš©)
# ---------------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("OpenCode-LlamaIndex")

# =====================
# 0) ë¡œì»¬ ëª¨ë¸ ì¤€ë¹„ ê°€ì´ë“œ (ì£¼ì„)
# =====================
# í„°ë¯¸ë„ì—ì„œ ë¯¸ë¦¬ ì•„ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:
#   ollama pull deepseek-r1
# Ollama ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸ëŠ” http://localhost:11434 ì…ë‹ˆë‹¤.

# =====================
# 1) LlamaIndex ì „ì—­ ì„¤ì •: ë¡œì»¬ LLM + ì„ë² ë”©
# =====================
OLLAMA_MODEL = os.environ.get("OC_LLM_MODEL", "deepseek-r1")
EMBED_MODEL = os.environ.get("OC_EMBED_MODEL", "BAAI/bge-m3")
PERSIST_DIR = os.environ.get("OC_PERSIST_DIR", "./storage")
DATA_DIR = os.environ.get("OC_DATA_DIR", "./data")

# LLM: Ollama(DeepSeek-R1)
Settings.llm = Ollama(
    model=OLLAMA_MODEL,
    request_timeout=60.0,
    # ì˜µì…˜: temperature, num_ctx, mirostat ë“± í•„ìš” ì‹œ ì¶”ê°€
)

# Embedding: BGE-M3 (HuggingFace)
Settings.embed_model = HuggingFaceEmbedding(model_name=EMBED_MODEL)

# =====================
# 2) ë¬¸ì„œ ë¡œë”© ìœ í‹¸
# =====================

def ensure_dir(path: str | Path):
    Path(path).mkdir(parents=True, exist_ok=True)


def save_uploaded_files(files: List[gr.File], target_dir: str) -> List[str]:
    """Gradioë¡œ ì—…ë¡œë“œëœ íŒŒì¼ë“¤ì„ target_dirì— ì €ì¥í•˜ê³  ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜."""
    ensure_dir(target_dir)
    saved = []
    for f in files or []:
        src = Path(f.name)
        dst = Path(target_dir) / src.name
        shutil.copy2(src, dst)
        saved.append(str(dst))
    return saved


def load_documents_from_dir(directory: str):
    """data í´ë”ì—ì„œ ì§€ì› í¬ë§· íŒŒì¼ë“¤ì„ ì½ì–´ LlamaIndex Document ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜"""
    ensure_dir(directory)
    reader = SimpleDirectoryReader(directory)
    docs = reader.load_data()
    return docs

# =====================
# 3) ì¸ë±ìŠ¤ ìƒì„±/ì¿¼ë¦¬/ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
# =====================

def build_index_from_dir(data_dir: str, persist_dir: str = PERSIST_DIR) -> str:
    """data_dirì˜ ë¬¸ì„œë¡œ ë²¡í„° ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ê³  persist_dirì— ì €ì¥."""
    docs = load_documents_from_dir(data_dir)
    if not docs:
        return "âŒ ë¬¸ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œ/ë°°ì¹˜í•˜ì„¸ìš”."
    index = VectorStoreIndex.from_documents(docs)
    index.storage_context.persist(persist_dir)
    return f"âœ… ì¸ë±ìŠ¤ ìƒì„± ë° ì €ì¥ ì™„ë£Œ â€¢ ë¬¸ì„œ ìˆ˜: {len(docs)} â€¢ ê²½ë¡œ: {persist_dir}"


def load_index(persist_dir: str = PERSIST_DIR):
    if not Path(persist_dir).exists():
        raise FileNotFoundError("ì €ì¥ëœ ì¸ë±ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¸ë±ìŠ¤ë¥¼ ìƒì„±/ì €ì¥í•˜ì„¸ìš”.")
    storage_context = StorageContext.from_defaults(persist_dir=persist_dir)
    index = load_index_from_storage(storage_context)
    return index


def query_index(query: str, top_k: int = 3, persist_dir: str = PERSIST_DIR) -> str:
    index = load_index(persist_dir)
    engine = index.as_query_engine(similarity_top_k=top_k)
    resp = engine.query(query)
    return str(resp)

# =====================
# 4) ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ì›ë¬¸ì˜ 3ê°œ ì§ˆë¬¸ ëŒ€ì‘)
# =====================
TEST_QUERIES = [
    "ì€ë¹„ì˜ ë‚˜ì´ëŠ”?",
    "ì€ë¹„ê°€ ì€ì‹ ì²˜ì—ì„œ ë§Œë‚œ ì¸ë¬¼ì€?",
    "ì€ë¹„ì™€ ìš©ë³‘ì´ ì«“ê¸°ëŠ” ì´ìœ ëŠ”?",
]

# =====================
# 5) Gradio UI
# =====================
with gr.Blocks(title="OpenCode â€¢ ë¡œì»¬ LlamaIndex (Ollama + BGE-M3)", theme=gr.themes.Soft()) as demo:
    gr.Markdown("""
    # ğŸ“š OpenCode â€¢ ë¡œì»¬ LlamaIndex (Ollama + DeepSeek-R1)
    - **ë¬¸ì„œ ì—…ë¡œë“œ â†’ ì¸ë±ìŠ¤ ìƒì„±/ì €ì¥ â†’ ì§ˆì˜ì‘ë‹µ â†’ ì¸ë±ìŠ¤ ì¬ë¡œë“œ**
    - LLM: DeepSeek-R1 (Ollama) / Embedding: BGE-M3 (HuggingFace)
    - 100% ë¡œì»¬, API í‚¤ ë¶ˆí•„ìš”
    """)

    with gr.Tabs():
        # ---------- íƒ­ 1: Build Index
        with gr.Tab("Build Index"):
            gr.Markdown("ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ data í´ë”ì— ë„£ì€ ë’¤ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.")
            uploads = gr.Files(label="ë¬¸ì„œ ì—…ë¡œë“œ (pdf, txt, md, docx ë“±)")
            data_dir_tb = gr.Textbox(value=DATA_DIR, label="ë°ì´í„° í´ë” ê²½ë¡œ")
            persist_tb = gr.Textbox(value=PERSIST_DIR, label="ì €ì¥ í´ë” ê²½ë¡œ")
            save_btn = gr.Button("ì—…ë¡œë“œ ì €ì¥")
            build_btn = gr.Button("ì¸ë±ìŠ¤ ìƒì„±/ì €ì¥", variant="primary")
            status_build = gr.Markdown("ìƒíƒœ: ëŒ€ê¸° ì¤‘")

            def do_save(files, tgt):
                saved = save_uploaded_files(files, tgt)
                return f"ì €ì¥ëœ íŒŒì¼ ìˆ˜: {len(saved)}\n" + "\n".join(saved)

            def do_build(ddir, pdir):
                try:
                    msg = build_index_from_dir(ddir, pdir)
                    return msg
                except Exception as e:
                    return f"âŒ ì˜¤ë¥˜: {e}"

            save_btn.click(do_save, [uploads, data_dir_tb], status_build)
            build_btn.click(do_build, [data_dir_tb, persist_tb], status_build)

        # ---------- íƒ­ 2: Query
        with gr.Tab("Query"):
            persist_q = gr.Textbox(value=PERSIST_DIR, label="ë¶ˆëŸ¬ì˜¬ ì €ì¥ í´ë” ê²½ë¡œ")
            topk = gr.Slider(1, 10, value=3, step=1, label="similarity_top_k")
            qbox = gr.Textbox(value=TEST_QUERIES[0], label="ì§ˆë¬¸", lines=2)
            ask_btn = gr.Button("ì§ˆì˜", variant="primary")
            ans_md = gr.Markdown()

            def do_query(pdir, k, q):
                try:
                    ans = query_index(q, int(k), pdir)
                    return ans
                except Exception as e:
                    return f"âŒ ì˜¤ë¥˜: {e}"

            ask_btn.click(do_query, [persist_q, topk, qbox], ans_md)

        # ---------- íƒ­ 3: Quick Demo
        with gr.Tab("Quick Demo"):
            gr.Markdown("ì›ë¬¸ ì˜ˆì œì˜ 3ê°œ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ ì‹¤í–‰í•´ë´…ë‹ˆë‹¤.")
            persist_d = gr.Textbox(value=PERSIST_DIR, label="ì €ì¥ í´ë” ê²½ë¡œ")
            run_demo = gr.Button("ì‹¤í–‰")
            demo_out = gr.Markdown()

            def do_demo(pdir):
                try:
                    outs = []
                    for q in TEST_QUERIES:
                        outs.append(f"**Q:** {q}\n**A:** {query_index(q, 3, pdir)}\n")
                    return "\n---\n".join(outs)
                except Exception as e:
                    return f"âŒ ì˜¤ë¥˜: {e}"

            run_demo.click(do_demo, [persist_d], demo_out)

    gr.Markdown("""
    ---
    ### ì‚¬ìš© íŒ
    - `data/` í´ë”ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê±°ë‚˜ íŒŒì¼ ì—…ë¡œë“œ í›„ "ì—…ë¡œë“œ ì €ì¥"ì„ ëˆ„ë¥´ì„¸ìš”.
    - "ì¸ë±ìŠ¤ ìƒì„±/ì €ì¥" í›„ì—ëŠ” Query íƒ­ì—ì„œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - ì¸ë±ìŠ¤ëŠ” `./storage`(ê¸°ë³¸ê°’)ì— ì €ì¥ë˜ë©°, ë‚˜ì¤‘ì— `load_index_from_storage`ë¡œ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
    - ì„ë² ë”© ëª¨ë¸ì€ ë©€í‹°ë§êµ¬ì–¼(BGE-M3)ì´ë¯€ë¡œ í•œêµ­ì–´/ì˜ì–´ ì„ì¸ ë¬¸ì„œì—ë„ ì˜ ë™ì‘í•©ë‹ˆë‹¤.
    - LLM ì‘ë‹µ ê¸¸ì´ë‚˜ ìŠ¤íƒ€ì¼ì€ Ollama ëª¨ë¸ ì˜µì…˜ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """)

if __name__ == "__main__":
    # Gradio ì•± ì‹¤í–‰
    demo.launch(server_name="0.0.0.0", server_port=7865, share=False)


