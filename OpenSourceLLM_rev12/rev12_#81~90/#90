#90
"""
OpenCode ë³€í™˜ë³¸: OpenAI TTS ì½”ë“œ â†’ ë¡œì»¬ Coqui TTS + Gradio
---------------------------------------------------------
- API Key, OpenAI ì˜ì¡´ ì œê±°
- ìˆœìˆ˜ ë¡œì»¬ TTS(ì˜¤í”ˆì†ŒìŠ¤): Coqui TTS (https://github.com/coqui-ai/TTS)
- í•œêµ­ì–´ ê¸°ë³¸ ëª¨ë¸ í¬í•¨: "tts_models/ko/kss/glow-tts"
- ë©€í‹° ìŠ¤í”¼ì»¤/ë‹¤êµ­ì–´ ëª¨ë¸ ì˜µì…˜ í¬í•¨: "tts_models/multilingual/multi-dataset/your_tts" ë“±
- ì¶œë ¥: WAV ê¸°ë³¸, pydub + ffmpegê°€ ìˆìœ¼ë©´ MP3ë„ ìë™ ì €ì¥
- GUI: Gradio, ë˜í•œ CLI ë‹¨ë°œ ì‹¤í–‰ ì§€ì›

ì‚¬ì „ ì¤€ë¹„
1) í•„ìˆ˜ ì„¤ì¹˜
   pip install -U TTS gradio soundfile numpy
   # (ì„ íƒ) MP3 ì €ì¥ì„ ì›í•˜ë©´
   pip install -U pydub
   # ffmpeg ì„¤ì¹˜(í”Œë«í¼ë³„): https://ffmpeg.org/download.html

2) ì‹¤í–‰
   python tts_ollama_local_gradio.py
   ë¸Œë¼ìš°ì €ì—ì„œ í…ìŠ¤íŠ¸ ì…ë ¥ â†’ ìŒì„± ëª¨ë¸/í™”ì ì„ íƒ â†’ í•©ì„±

í´ë” êµ¬ì¡° ì˜ˆì‹œ(ìë™ ìƒì„±)
- src/data/tts/speech_ko.txt (ìƒ˜í”Œ í…ìŠ¤íŠ¸)
- src/data/tts/outputs/ (í•©ì„± ê²°ê³¼)
"""
from __future__ import annotations
import os
import time
from dataclasses import dataclass
from typing import List, Optional, Tuple

import numpy as np
import soundfile as sf

try:
    from pydub import AudioSegment  # MP3 ë³€í™˜ìš©(ì„ íƒ)
    HAVE_PYDUB = True
except Exception:
    HAVE_PYDUB = False

import gradio as gr
from TTS.api import TTS

# ===============================
# ê²½ë¡œ/ìœ í‹¸
# ===============================
BASE_DIR = os.path.abspath(os.path.dirname(__file__))
DATA_DIR = os.path.join(BASE_DIR, "src", "data", "tts")
OUT_DIR = os.path.join(DATA_DIR, "outputs")
SAMPLE_TXT = os.path.join(DATA_DIR, "speech_ko.txt")

os.makedirs(OUT_DIR, exist_ok=True)
if not os.path.exists(SAMPLE_TXT):
    os.makedirs(DATA_DIR, exist_ok=True)
    with open(SAMPLE_TXT, "w", encoding="utf-8") as f:
        f.write("ì•ˆë…• ë„¤ì˜¤ â€“ ë§¤íŠ¸ë¦­ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.")

# ===============================
# Coqui TTS ëª¨ë¸ ê´€ë¦¬
# ===============================
@dataclass
class ModelSpec:
    name: str  # í‘œì‹œëª…
    repo_id: str  # Coqui TTS model id
    note: str  # ì„¤ëª…

# ìì£¼ ì“°ëŠ” ëª¨ë¸ ëª¨ìŒ (í•„ìš”ì‹œ ì¶”ê°€)
MODEL_CATALOG: List[ModelSpec] = [
    ModelSpec(
        name="Korean: Glow-TTS (ko)",
        repo_id="tts_models/ko/kss/glow-tts",
        note="í•œêµ­ì–´ ë‹¨ì¼ í™”ì(í’ˆì§ˆ ìš°ìˆ˜, ë¹ ë¦„)",
    ),
    ModelSpec(
        name="Multilingual: YourTTS (multi)",
        repo_id="tts_models/multilingual/multi-dataset/your_tts",
        note="ë‹¤êµ­ì–´/ë©€í‹°ìŠ¤í”¼ì»¤, ê¸°ì¤€ ìŒì„±(í´ë¡œë‹)ë„ ì§€ì›",
    ),
    ModelSpec(
        name="English: VITS VCTK (en, multi-speaker)",
        repo_id="tts_models/en/vctk/vits",
        note="ì˜ì–´ ë©€í‹° ìŠ¤í”¼ì»¤",
    ),
]

# ìºì‹œ: ë¡œë”©ëœ TTS ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©
_TTS_CACHE = {}


def load_tts(repo_id: str) -> TTS:
    if repo_id in _TTS_CACHE:
        return _TTS_CACHE[repo_id]
    t0 = time.time()
    tts = TTS(model_name=repo_id)  # ìµœì´ˆ ì‹¤í–‰ ì‹œ ëª¨ë¸ ê°€ì¤‘ì¹˜ ìë™ ë‹¤ìš´ë¡œë“œ
    _TTS_CACHE[repo_id] = tts
    print(f"[TTS] Loaded {repo_id} in {time.time() - t0:.2f}s")
    return tts


# ===============================
# í•©ì„± í•¨ìˆ˜
# ===============================

def synthesize(
    text: str,
    model_label: str,
    speaker: Optional[str] = None,
    language: Optional[str] = None,
    file_basename: str = "speech_ko",
    save_mp3: bool = True,
) -> Tuple[str, str, List[str]]:
    """
    ì…ë ¥ í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•œ Coqui TTS ëª¨ë¸ë¡œ í•©ì„±í•˜ì—¬ íŒŒì¼ ì €ì¥.
    - speaker: ë©€í‹°ìŠ¤í”¼ì»¤ ëª¨ë¸ì—ì„œ í™”ìëª… (ì—†ìœ¼ë©´ ê¸°ë³¸)
    - language: ë‹¤êµ­ì–´ ëª¨ë¸ì—ì„œ ì–¸ì–´ì½”ë“œ (ì˜ˆ: "ko", "en", "ja", ...)
    - ë°˜í™˜: (ë¯¸ë¦¬ë“£ê¸° íŒŒì¼ ê²½ë¡œ, ì €ì¥ëœ ë©”ì„¸ì§€, ìƒì„±ëœ íŒŒì¼ ëª©ë¡)
    """
    if not text or not text.strip():
        return "", "ì…ë ¥ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.", []

    # ëª¨ë¸ ID ì°¾ê¸°
    repo_id = next((m.repo_id for m in MODEL_CATALOG if m.name == model_label), None)
    if repo_id is None:
        return "", f"ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë¸: {model_label}", []

    # ëª¨ë¸ ë¡œë“œ
    tts = load_tts(repo_id)

    # ì¶œë ¥ íŒŒì¼ëª…
    wav_path = os.path.join(OUT_DIR, f"{file_basename}.wav")

    # í•©ì„± ì‹¤í–‰
    # Coqui TTSëŠ” ëª¨ë¸ë§ˆë‹¤ ì§€ì› íŒŒë¼ë¯¸í„°ê°€ ë‹¤ë¥´ë¯€ë¡œ ê³µí†µ íŒŒë¼ë¯¸í„°ë§Œ ì‚¬ìš©
    # tts_to_fileëŠ” ë‚´ë¶€ì—ì„œ ìƒ˜í”Œë ˆì´íŠ¸/ì±„ë„ì„ ì²˜ë¦¬í•´ WAV ì €ì¥
    kwargs = {}
    if speaker:
        kwargs["speaker"] = speaker
    if language:
        kwargs["language"] = language

    try:
        tts.tts_to_file(text=text, file_path=wav_path, **kwargs)
    except TypeError as e:
        # ì¼ë¶€ ëª¨ë¸ì€ language/speaker ë¯¸ì§€ì› â†’ íŒŒë¼ë¯¸í„° ì œê±° í›„ ì¬ì‹œë„
        if "unexpected keyword" in str(e):
            kwargs = {}
            tts.tts_to_file(text=text, file_path=wav_path)
        else:
            raise

    created_files = [wav_path]
    preview_path = wav_path
    msg = f"WAV ì €ì¥: {os.path.relpath(wav_path, BASE_DIR)}"

    # MP3 ë³€í™˜(ì„ íƒ)
    if save_mp3 and HAVE_PYDUB:
        mp3_path = os.path.join(OUT_DIR, f"{file_basename}.mp3")
        try:
            audio = AudioSegment.from_wav(wav_path)
            audio.export(mp3_path, format="mp3", bitrate="192k")
            created_files.append(mp3_path)
            preview_path = mp3_path  # Gradio AudioëŠ” mp3 ì¬ìƒì´ í¸ë¦¬
            msg += f"\nMP3 ì €ì¥: {os.path.relpath(mp3_path, BASE_DIR)}"
        except Exception as e:
            msg += f"\nMP3 ë³€í™˜ ì‹¤íŒ¨(pydub/ffmpeg í•„ìš”): {e}"

    return preview_path, msg, [os.path.relpath(p, BASE_DIR) for p in created_files]


# ===============================
# ìŠ¤í”¼ì»¤/ì–¸ì–´ ì¡°íšŒ
# ===============================

def list_speakers_and_langs(model_label: str) -> Tuple[List[str], List[str]]:
    repo_id = next((m.repo_id for m in MODEL_CATALOG if m.name == model_label), None)
    if repo_id is None:
        return [], []
    tts = load_tts(repo_id)
    speakers = getattr(tts, "speakers", []) or []
    languages = getattr(tts, "languages", []) or []
    # ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ ë³´ì¥
    speakers = [str(s) for s in speakers]
    languages = [str(l) for l in languages]
    return speakers, languages


# ===============================
# Gradio UI
# ===============================

MODEL_NAMES = [m.name for m in MODEL_CATALOG]
DEFAULT_MODEL_NAME = MODEL_NAMES[0]

with gr.Blocks(title="ë¡œì»¬ TTS (Coqui) â€” OpenCode", theme=gr.themes.Soft()) as demo:
    gr.Markdown(
        """
        # ğŸ—£ï¸ ë¡œì»¬ TTS (Coqui) â€” OpenCode
        - ì˜¤í”ˆì†ŒìŠ¤ Coqui TTSë¡œ **ì™„ì „ ë¡œì»¬** ìŒì„± í•©ì„±
        - í•œêµ­ì–´ ê¸°ë³¸ ëª¨ë¸ ì œê³µ, ë‹¤êµ­ì–´/ë©€í‹° ìŠ¤í”¼ì»¤ ëª¨ë¸ ì„ íƒ ê°€ëŠ¥
        - MP3 ë³€í™˜ì€ pydub+ffmpegê°€ ìˆì„ ë•Œ ìë™ í™œì„±í™”
        """
    )

    with gr.Row():
        txt = gr.Textbox(label="í…ìŠ¤íŠ¸ ì…ë ¥", value="ì•ˆë…• ë„¤ì˜¤ â€“ ë§¤íŠ¸ë¦­ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.", lines=3)

    with gr.Row():
        model_dd = gr.Dropdown(MODEL_NAMES, value=DEFAULT_MODEL_NAME, label="ìŒì„± ëª¨ë¸")
        spk_dd = gr.Dropdown([], label="í™”ì(speaker)", info="ëª¨ë¸ ì„ íƒ í›„ ìë™ ì±„ì›€", interactive=True)
        lang_dd = gr.Dropdown([], label="ì–¸ì–´(language)", info="ë‹¤êµ­ì–´ ëª¨ë¸ë§Œ í‘œì‹œ", interactive=True)
        base_fn = gr.Textbox(value="speech_ko", label="íŒŒì¼ ë² ì´ìŠ¤ëª…")
        mp3_cb = gr.Checkbox(value=True, label="MP3ë„ ì €ì¥(pydub/ffmpeg í•„ìš”)")

    refresh_btn = gr.Button("ëª¨ë¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨(í™”ì/ì–¸ì–´)")

    with gr.Row():
        run_btn = gr.Button("í•©ì„± ì‹¤í–‰", variant="primary")

    audio_out = gr.Audio(label="ë¯¸ë¦¬ë“£ê¸°", autoplay=False)
    msg_out = gr.Textbox(label="ì €ì¥ ë¡œê·¸", lines=4)
    files_out = gr.JSON(label="ìƒì„±ëœ íŒŒì¼ ëª©ë¡")

    # ì´ë²¤íŠ¸: ëª¨ë¸ ë³€ê²½ ì‹œ í™”ì/ì–¸ì–´ ì±„ìš°ê¸°
    def _refresh(model_label):
        speakers, languages = list_speakers_and_langs(model_label)
        # ë¹ˆ í•­ëª© ì¶”ê°€(ì„ íƒ ì•ˆí•¨)
        speakers = [""] + speakers if speakers else []
        languages = [""] + languages if languages else []
        return gr.update(choices=speakers, value=("" if speakers else None)), \
               gr.update(choices=languages, value=("" if languages else None))

    model_dd.change(_refresh, inputs=[model_dd], outputs=[spk_dd, lang_dd])
    refresh_btn.click(_refresh, inputs=[model_dd], outputs=[spk_dd, lang_dd])

    # í•©ì„± ì‹¤í–‰
    def _run(text, model_label, speaker, language, base_name, mp3_on):
        spk = speaker.strip() if speaker else None
        lang = language.strip() if language else None
        return synthesize(text, model_label, spk, lang, base_name.strip() or "speech", save_mp3=bool(mp3_on))

    run_btn.click(_run, inputs=[txt, model_dd, spk_dd, lang_dd, base_fn, mp3_cb], outputs=[audio_out, msg_out, files_out])

    gr.Markdown(
        """
        ### íŒ
        - í•œêµ­ì–´ë§Œ í•„ìš”í•˜ë©´ **Korean: Glow-TTS** ëª¨ë¸ì´ ê°„ë‹¨í•˜ê³  ë¹ ë¦…ë‹ˆë‹¤.
        - ë©€í‹° ìŠ¤í”¼ì»¤ ëª¨ë¸ì€ `speaker` ëª©ë¡ì—ì„œ ë‹¤ì–‘í•œ í™”ìë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ê¸´ ë¬¸ì¥ì€ ë¬¸ì¥ë¶€í˜¸ë¡œ ì ì ˆíˆ ëŠì–´ ì£¼ë©´ ë°œìŒ/ë¦¬ë“¬ì´ ìì—°ìŠ¤ëŸ¬ì›Œì§‘ë‹ˆë‹¤.
        - MP3 ë³€í™˜ì´ ì‹¤íŒ¨í•˜ë©´ ffmpeg ì„¤ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        """
    )

# ===============================
# CLI ì‹¤í–‰ (ì˜µì…˜)
# ===============================

def cli_demo_example() -> bool:
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--text", type=str, help="í•©ì„±í•  í…ìŠ¤íŠ¸")
    parser.add_argument("--model", type=str, default=DEFAULT_MODEL_NAME, choices=MODEL_NAMES)
    parser.add_argument("--speaker", type=str, default="")
    parser.add_argument("--language", type=str, default="")
    parser.add_argument("--base", type=str, default="speech_cli")
    parser.add_argument("--no-mp3", action="store_true")
    args = parser.parse_args()

    if not args.text:
        return False

    prev, msg, files = synthesize(
        text=args.text,
        model_label=args.model,
        speaker=(args.speaker or None),
        language=(args.language or None),
        file_basename=args.base,
        save_mp3=(not args.no_mp3),
    )
    print("ë¯¸ë¦¬ë“£ê¸° íŒŒì¼:", prev)
    print("ë©”ì‹œì§€:\n", msg)
    print("ìƒì„± íŒŒì¼:", files)
    return True


if __name__ == "__main__":
    if not cli_demo_example():
        demo.launch()

# pip install -U TTS gradio soundfile numpy
# (ì„ íƒ) MP3 ì €ì¥ ì›í•˜ë©´:
# pip install -U pydub   # + ffmpeg ì„¤ì¹˜

