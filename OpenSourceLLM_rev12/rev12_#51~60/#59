#59
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
from langchain_text_splitters import CharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_community.document_loaders import TextLoader
from langchain_community.embeddings import OllamaEmbeddings
import os
import gradio as gr

# í˜„ì¬ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìœ„ì¹˜ ë°˜í™˜
current_dir = os.path.dirname(os.path.abspath(__file__))

# "restaurant-faiss" í´ë” ê²½ë¡œ
restaurant_faiss = os.path.join(current_dir, "restaurant-faiss")

# -------------------------------------------------------------------
# 1. í…ìŠ¤íŠ¸ ë¬¸ì„œ ë¡œë“œ ë° ë¶„í• 
# -------------------------------------------------------------------
# "restaurants.txt" íŒŒì¼ ë¡œë“œ
loader = TextLoader(f'{current_dir}/restaurants.txt', encoding="utf-8")
documents = loader.load()

# í…ìŠ¤íŠ¸ë¥¼ 300ì ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ê³  50ì ê²¹ì¹¨ì„ ì¤Œ
text_splitter = CharacterTextSplitter(chunk_size=300, chunk_overlap=50)
docs = text_splitter.split_documents(documents)

# -------------------------------------------------------------------
# 2. ì„ë² ë”© ëª¨ë¸ (Ollama + DeepSeek-R1)
# -------------------------------------------------------------------
# Ollamaì— ì„¤ì¹˜ëœ ë¡œì»¬ ì„ë² ë”© ëª¨ë¸ ì‚¬ìš© (ì˜ˆ: "nomic-embed-text")
# Ollama í„°ë¯¸ë„ì—ì„œ `ollama pull nomic-embed-text` í•„ìš”
embeddings = OllamaEmbeddings(model="nomic-embed-text")

# -------------------------------------------------------------------
# 3. ë²¡í„° DB (FAISS) ìƒì„± ë° ì €ì¥
# -------------------------------------------------------------------
db = FAISS.from_documents(docs, embeddings)
db.save_local(restaurant_faiss)
print("ë ˆìŠ¤í† ë‘ ì„ë² ë”© ì €ì¥ ì™„ë£Œ:", restaurant_faiss)

# -------------------------------------------------------------------
# 4. Gradio ì¸í„°í˜ì´ìŠ¤ (ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ)
# -------------------------------------------------------------------
# ì €ì¥ëœ ë²¡í„° DB ë¡œë“œ
db = FAISS.load_local(restaurant_faiss, embeddings, allow_dangerous_deserialization=True)

# ê²€ìƒ‰ í•¨ìˆ˜ ì •ì˜
def search_restaurant(query):
    # ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì§ˆë¬¸ì— ëŒ€í•´ ìƒìœ„ 3ê°œ ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰
    results = db.similarity_search(query, k=3)
    # ê²€ìƒ‰ëœ ê²°ê³¼ë¥¼ ë¬¸ìì—´ë¡œ ë°˜í™˜
    output = "\n\n".join([f"ğŸ”¹ {res.page_content}" for res in results])
    return output if output else "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."

# Gradio UI êµ¬ì„±
with gr.Blocks() as demo:
    gr.Markdown("## ğŸ½ï¸ ë ˆìŠ¤í† ë‘ ì¶”ì²œ ê²€ìƒ‰ê¸° (DeepSeek + FAISS)")
    with gr.Row():
        with gr.Column(scale=2):
            query = gr.Textbox(label="ê²€ìƒ‰ì–´ ì…ë ¥", placeholder="ì˜ˆ: ì„œìš¸ì— ìˆëŠ” ì¼ì‹ì§‘ ì¶”ì²œí•´ì¤˜")
            btn = gr.Button("ê²€ìƒ‰ ì‹¤í–‰")
        with gr.Column(scale=3):
            output = gr.Textbox(label="ê²€ìƒ‰ ê²°ê³¼", lines=10)

    btn.click(search_restaurant, inputs=query, outputs=output)

# ì‹¤í–‰
if __name__ == "__main__":
    demo.launch(server_name="0.0.0.0", server_port=7860)










